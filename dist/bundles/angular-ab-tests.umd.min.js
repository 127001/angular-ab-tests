!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core")):"function"==typeof define&&define.amd?define(["exports","@angular/core"],t):t((e.ng=e.ng||{},e.ng.angularabtests=e.ng.angularabtests||{}),e.ng.core)}(this,function(e,t){"use strict";function r(e){throw"AngularAbTests error: "+e}var o=function(){function e(e,t){this._versions=[],this._versions=e,this._chosenVersion=t}return e.prototype.shouldRender=function(e,t){for(var o=0,n=e;o<n.length;o++){var i=n[o];-1===this._versions.indexOf(i)&&r("Version <"+i+"> has not been declared: [ "+this._versions.join(", ")+" ]")}return-1!==e.indexOf(this._chosenVersion)},e}(),n=function(){function e(e){e&&(this._version=e)}return e.prototype.shouldRender=function(e,t){return t||!!this._version&&-1!==e.indexOf(this._version)},e}(),i=function(){function e(){}return e.prototype.setWeights=function(e){this._weights=e},e.prototype.setVersions=function(e){this._versions=e},e.prototype.run=function(){if(0===this._weights.length)return this._versions[Math.floor(Math.random()*this._versions.length)];for(var e=100*Math.random(),t=0,r=this._weights;t<r.length;t++){var o=r[t];if(e<=o[0])return o[1]}return this._versions[0]},e}(),s=function(){function e(){this._regexps=[/bot/i,/spider/i,/facebookexternalhit/i,/simplepie/i,/yahooseeker/i,/embedly/i,/quora link preview/i,/outbrain/i,/vkshare/i,/monit/i,/Pingability/i,/Monitoring/i,/WinHttpRequest/i,/Apache-HttpClient/i,/getprismatic.com/i,/python-requests/i,/Twurly/i,/yandex/i,/browserproxy/i,/Monitoring/i,/crawler/i,/Qwantify/i,/Yahoo! Slurp/i,/pinterest/i]}return e.prototype.isCrawler=function(){return this._regexps.some(function(e){return e.test(window.navigator.userAgent)})},e}(),a=function(){function e(){}return e.prototype.get=function(e){e=encodeURIComponent(e);var t=new RegExp("(?:^"+e+"|;\\s*"+e+")=(.*?)(?:;|$)","g"),r=t.exec(document.cookie);return r?decodeURIComponent(r[1]):""},e.prototype.set=function(e,t,r,o){var n=encodeURIComponent(e)+"="+encodeURIComponent(t)+";";if(o){n+="expires="+new Date((new Date).getTime()+1e3*o*60*60*24).toUTCString()+";"}r&&(n+="domain="+r+";"),document.cookie=n},e}(),u=new t.InjectionToken("ANGULAR_AB_TEST_CONFIG"),c=new t.InjectionToken("ANGULAR_AB_TEST_COOKIE_HANDLER"),p=new t.InjectionToken("ANGULAR_AB_TEST_CRAWLER_DETECTOR"),h=new t.InjectionToken("ANGULAR_AB_TEST_RANDOM_EXTRACTOR"),f=function(){function e(e,t,o,n){this._tests={},this._defaultScope="default",this._cookieHandler=t,this._randomExtractor=n;for(var i=o.isCrawler(),s=0,a=e;s<a.length;s++){var u=a[s],c=this._defaultScope;u.scope&&(c=u.scope),this._tests[c]&&r("Test with scope <"+c+"> cannot be initialized twice"),i?this.setupTestForCrawler(c,this.filterVersions(u.versions),u):this.setupTestForRealUser(c,this.filterVersions(u.versions),u)}}return e.prototype.shouldRender=function(e,t,o){var n=t||this._defaultScope;return this._tests[n]||r("Test with scope <"+n+"> has not been defined"),this._tests[n].shouldRender(e,o)},e.prototype.filterVersions=function(e){var t=[];e.length<2&&r("You have to provide at least two versions");for(var o=0,n=e;o<n.length;o++){var i=n[o];-1!==t.indexOf(i)&&r("Version <"+i+"> is repeated in the array of versions [ "+e.join(", ")+" ]"),t.push(i)}return t},e.prototype.setupTestForCrawler=function(e,t,o){o.versionForCrawlers&&-1===t.indexOf(o.versionForCrawlers)&&r("Version for crawlers <"+o.versionForCrawlers+"> is not included in versions [ "+t.join(", ")+" ]"),this._tests[e]=new n(o.versionForCrawlers)},e.prototype.setupTestForRealUser=function(e,t,r){var n=this.generateVersion({versions:t,cookieName:"angular-ab-tests-"+e,domain:r.domain,expiration:r.expiration,weights:r.weights});this._tests[e]=new o(t,n)},e.prototype.generateVersion=function(e){var t=this._cookieHandler.get(e.cookieName);return-1!==e.versions.indexOf(t)?t:(this._randomExtractor.setWeights(this.processWeights(e.weights||{},e.versions)),this._randomExtractor.setVersions(e.versions),t=this._randomExtractor.run(),this._cookieHandler.set(e.cookieName,t,e.domain,e.expiration),t)},e.prototype.processWeights=function(e,t){var o=[],n=0,i=t.slice(0),s=-100;for(var a in e)s=i.indexOf(a),-1===s&&r("Weight associated to <"+a+"> which is not included in versions [ "+t.join(", ")+" ]"),i.splice(s,1),n+=this.roundFloat(e[a]),o.push([n,a]);if(-100===s)return[];n>=100&&r("Sum of weights is <"+n+">, while it should be less than 100");for(var u=this.roundFloat((100-n)/i.length),c=0,p=i;c<p.length;c++){var h=p[c];n+=u,o.push([n,h])}return o[o.length-1]=[100,o[o.length-1][1]],o},e.prototype.roundFloat=function(e){return Math.round(1e3*e)/1e3},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:Array,decorators:[{type:t.Inject,args:[u]}]},{type:a,decorators:[{type:t.Inject,args:[c]}]},{type:s,decorators:[{type:t.Inject,args:[p]}]},{type:i,decorators:[{type:t.Inject,args:[h]}]}]},e}(),l=function(){function e(e,t,r){this._service=e,this._viewContainer=t,this._templateRef=r,this._forCrawlers=!1}return e.prototype.ngOnInit=function(){this._service.shouldRender(this._versions,this._scope,this._forCrawlers)&&this._viewContainer.createEmbeddedView(this._templateRef)},Object.defineProperty(e.prototype,"abTestVersion",{set:function(e){this._versions=e.split(",")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"abTestVersionScope",{set:function(e){this._scope=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"abTestVersionForCrawlers",{set:function(e){this._forCrawlers=e},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[abTestVersion]"}]}],e.ctorParameters=function(){return[{type:f},{type:t.ViewContainerRef},{type:t.TemplateRef}]},e.propDecorators={abTestVersion:[{type:t.Input}],abTestVersionScope:[{type:t.Input}],abTestVersionForCrawlers:[{type:t.Input}]},e}(),d=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[f,{provide:u,useValue:t},{provide:c,useClass:a},{provide:p,useClass:s},{provide:h,useClass:i}]}},e.decorators=[{type:t.NgModule,args:[{declarations:[l],exports:[l]}]}],e.ctorParameters=function(){return[]},e}();e.AbTestsModule=d,e.AB_TESTS_COOKIE_HANDLER_TOKEN=c,e.AB_TESTS_CRAWLER_DETECTOR_TOKEN=p,e.AB_TESTS_RANDOM_EXTRACTOR_TOKEN=h,e.AbTestVersionDirective=l,Object.defineProperty(e,"__esModule",{value:!0})});